<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
</head>

<body>
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            // 支持两种参数格式：官方格式(c/encode)和简化格式(type/format)
            let types = params.getAll('c') || params.getAll('type') || [];
            const encode = params.get('encode') || params.get('format') || 'json';
            const charset = params.get('charset') || 'utf-8';
            const callback = params.get('callback') || 'hitokoto';
            const select = params.get('select') || '.hitokoto';
            const minLength = parseInt(params.get('min_length') || '0');
            const maxLength = parseInt(params.get('max_length') || '30');

            // 默认所有类型
            const allTypes = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l'];

            // 如果没有指定类型，随机选择一个
            if (types.length === 0) {
                types = [allTypes[Math.floor(Math.random() * allTypes.length)]];
            }

            // 过滤无效的类型
            types = types.filter(t => allTypes.includes(t));
            if (types.length === 0) {
                types = [allTypes[Math.floor(Math.random() * allTypes.length)]];
            }

            // 随机选择一个类型
            const selectedType = types[Math.floor(Math.random() * types.length)];

            fetch(`../sentences/${selectedType}.json`)
                .then(response => response.json())
                .then(data => {
                    // 按长度范围过滤
                    const filtered = data.filter(s => s.length >= minLength && s.length <= maxLength);

                    if (filtered.length === 0) {
                        // 如果没有符合条件的句子，返回错误
                        throw new Error('没有符合条件的一言');
                    }

                    const sentence = filtered[Math.floor(Math.random() * filtered.length)];

                    if (encode === 'text') {
                        // 纯文本格式
                        document.write(sentence.hitokoto);
                    } else if (encode === 'js') {
                        // JavaScript 格式，支持选择器注入
                        const jsCode = `
                            (function() {
                                var element = document.querySelector('${select}');
                                if (element) {
                                    element.innerHTML = ${JSON.stringify(sentence.hitokoto)};
                                }
                            })();
                        `;
                        document.write(jsCode);
                    } else if (encode === 'jsonp') {
                        // JSONP 格式
                        document.write(callback + '(' + JSON.stringify(sentence) + ')');
                    } else {
                        // JSON 格式（默认）
                        document.write(JSON.stringify(sentence));
                    }
                })
                .catch(error => {
                    const errorResponse = {
                        error: error.message || '加载失败'
                    };

                    if (encode === 'js') {
                        document.write('console.error(' + JSON.stringify(errorResponse) + ');');
                    } else if (encode === 'jsonp') {
                        document.write(callback + '(' + JSON.stringify(errorResponse) + ')');
                    } else {
                        document.write(JSON.stringify(errorResponse));
                    }
                });
        })();
    </script>
</body>

</html>