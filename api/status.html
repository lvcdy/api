<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站可用性检测API</title>
</head>
<body>
<script>
(function() {
    // 解析URL参数
    const params = new URLSearchParams(window.location.search);
    const url = params.get('url');
    const format = params.get('format') || 'json';
    
    if (!url) {
        const errorResponse = {
            error: '参数错误',
            message: '请提供url参数',
            usage: '?url=https://example.com'
        };
        document.write(JSON.stringify(errorResponse, null, 2));
        return;
    }
    
    // 检测网站可用性
    const startTime = Date.now();
    const img = new Image();
    let timeout = null;
    let responded = false;
    
    const respond = (status, message) => {
        if (responded) return;
        responded = true;
        
        clearTimeout(timeout);
        
        const responseTime = Date.now() - startTime;
        const result = {
            url: url,
            status: status,
            message: message,
            responseTime: responseTime + 'ms',
            timestamp: new Date().toISOString()
        };
        
        if (format === 'text') {
            document.write(status);
        } else if (format === 'js') {
            const callback = params.get('callback') || 'statusCallback';
            document.write(callback + '(' + JSON.stringify(result) + ')');
        } else {
            document.write(JSON.stringify(result, null, 2));
        }
    };
    
    // 超时设置(10秒)
    timeout = setTimeout(() => {
        respond('timeout', '请求超时');
    }, 10000);
    
    // 尝试加载图片或favicon
    img.onload = () => respond('online', '网站可访问');
    img.onerror = () => {
        // 如果直接加载失败,尝试加载favicon
        const faviconUrl = new URL(url).origin + '/favicon.ico';
        const favicon = new Image();
        favicon.onload = () => respond('online', '网站可访问');
        favicon.onerror = () => respond('unknown', '无法确定状态(可能存在CORS限制)');
        favicon.src = faviconUrl;
    };
    
    // 尝试加载目标URL
    try {
        img.src = url;
    } catch (e) {
        respond('error', '无效的URL: ' + e.message);
    }
})();
</script>
</body>
</html>
